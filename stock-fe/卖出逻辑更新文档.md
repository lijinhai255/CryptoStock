# 卖出逻辑更新文档

## 概述

本次更新为 CryptoStock 前端应用添加了完整的代币卖出功能，使其与现有的买入功能保持一致。卖出逻辑严格按照测试文件 `/Users/lijinhai/Desktop/my_project/CryptoStock/CryptoStockContract/test/12-PriceOracle-AAPL.test.js` 中的实现方式进行开发。

## 主要修改

### 1. 新增 `sellTokens` 函数

在 `lib/hooks/useTokenTrading.ts` 文件中新增了 `sellTokens` 函数，实现了完整的卖出流程：

- **函数签名**: `sellTokens(sellAmount: string): Promise<TradingResult>`
- **参数**: 卖出的代币数量（字符串格式）
- **返回值**: 包含成功状态、交易哈希和错误信息的 TradingResult 对象

### 2. 预言机数据结构一致性

卖出功能使用了与买入功能完全相同的预言机数据结构：

```javascript
// 测试文件第 671-675 行的数据结构
const updateDataArray = [
  pythUpdateData,                    // Pyth 的原始数据 (bytes[])
  [redStoneData.updateData]         // RedStone 的数据包装成数组
];
```

### 3. 费用计算逻辑

严格按照测试文件第 686-690 行的公式实现费用计算：

```javascript
// 获取合约的交易费率
const tradeFeeRate = await publicClient.readContract({
  address: token.address,
  abi: STOCK_TOKEN_ABI,
  functionName: "tradeFeeRate"
}) as bigint;

// 按照测试文件公式计算
const expectedUsdtBeforeFee = (sellAmountWei * currentPrice) / ethers.parseEther("1000000000000");
const feeAmount = (expectedUsdtBeforeFee * tradeFeeRate) / 10000n;
const expectedUsdtAmount = expectedUsdtBeforeFee - feeAmount;
const minUsdtAmount = expectedUsdtAmount * 90n / 100n; // 10%滑点保护
```

### 4. 合约调用方式

完全按照测试文件第 712-717 行的方式调用 sell 函数：

```javascript
const sellTx = await aaplToken.connect(user).sell(
  sellAmount,           // 参数1: 代币数量
  minUsdtAmount,       // 参数2: 最小USDT数量
  updateDataArray,     // 参数3: 预言机数据
  { value: updateFee } // 预言机更新费用
);
```

## 功能特性

### 1. 完整的余额检查
- 检查用户代币余额是否足够
- 检查合约 USDT 余额是否足够支付卖出
- 检查用户 ETH 余额是否足够支付预言机费用

### 2. 动态价格获取
- 实时获取 Pyth 和 RedStone 预言机数据
- 使用 PriceAggregator 获取聚合价格
- 完整的数据验证和格式化

### 3. 精确的费用计算
- 从合约获取实际的交易费率（而非硬编码）
- 使用与测试文件一致的公式计算预期 USDT 数量
- 支持 10% 滑点保护

### 4. 错误处理和用户友好提示
- 详细的错误分析和分类
- 针对不同错误类型提供具体的用户操作建议
- 完整的调试日志用于问题排查

## 技术实现细节

### 1. 数据类型处理
- 代币数量使用 18 位精度（parseUnits(sellAmount, 18)）
- USDT 金额使用 6 位精度（formatUnits(amount, 6)）
- 所有 BigInt 类型的一致性处理

### 2. 预言机数据验证
- 自定义十六进制验证函数
- 递归验证 updateDataArray 中的每个元素
- 数据清理和格式化

### 3. 状态管理
- 复用现有的交易状态（'buying' 状态用于卖出）
- 更新交易哈希和状态信息
- 与买入功能保持一致的状态流转

## 导出更新

在 `useTokenTrading` hook 的返回对象中新增了 `sellTokens` 方法：

```javascript
return {
  // ... 其他属性
  sellTokens,  // 新增的卖出函数
  // ... 其他属性
};
```

## 使用方式

### 基本用法
```javascript
const { sellTokens } = useTokenTrading(token, usdtAddress, oracleAddress);

const result = await sellTokens("10"); // 卖出 10 个代币
if (result.success) {
  console.log("卖出成功，交易哈希:", result.hash);
} else {
  console.error("卖出失败:", result.error);
}
```

### 错误处理
函数会自动处理以下错误情况：
- 钱包未连接
- 卖出金额无效
- 代币余额不足
- 合约 USDT 余额不足
- ETH 余额不足（支付预言机费用）
- 价格数据获取失败
- 合约执行失败

## 与测试文件的对应关系

| 测试文件行数 | 前端实现 | 功能描述 |
|-------------|----------|----------|
| 671-675 | updateDataArray 组装 | 预言机数据结构 |
| 678 | updateFee 计算 | 预言机费用获取 |
| 682 | currentPrice 获取 | 聚合价格获取 |
| 686 | tradeFeeRate 获取 | 动态费率获取 |
| 687-690 | 费用计算公式 | 预期收益计算 |
| 712-717 | sell 函数调用 | 合约卖出交易 |

## 注意事项

1. **费用率动态获取**: 与买入功能使用固定费率（30n）不同，卖出功能从合约动态获取实际费率
2. **精度处理**: 注意代币（18位）和USDT（6位）的精度差异
3. **状态复用**: 暂时复用 'buying' 状态，后续可考虑添加专门的 'selling' 状态
4. **数据验证**: 严格遵循测试文件的数据格式要求，确保合约调用成功

## 测试建议

1. 在测试环境中验证卖出功能的完整流程
2. 测试不同金额的卖出交易
3. 验证滑点保护机制
4. 测试各种错误情况的处理
5. 确认预言机数据获取的稳定性

## 总结

本次更新成功为 CryptoStock 前端应用添加了完整的代币卖出功能，与现有的买入功能形成了完整的交易闭环。实现严格按照测试文件的标准，确保了与智能合约的完美兼容性。