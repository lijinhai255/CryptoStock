# 费用计算修复文档

## 问题描述
在交易过程中出现错误：`AbiFunctionNotFoundError: Function "getUpdateFee" 不存在。

## 问题分析
根据测试用例 `12-PriceOracle-AAPL.test.js` 中的逻辑，费用计算应该使用 `pythPriceFeed.getUpdateFee()` 而不是 `PriceAggregator.getUpdateFee()`。

## 测试用例中的正确做法

### 费用计算（第119行）：
```javascript
const updateFee = await pythPriceFeed.getUpdateFee(pythUpdateData);
console.log(`   💰 更新费用: ${updateFee.toString()} wei`);
```

### 聚合价格计算（第123行）：
```javascript
const aggregatedPrice = await priceAggregator.getAggregatedPrice.staticCall(
  TEST_SYMBOL,
  updateDataArray,
  { value: updateFee }
);
```

## 修复内容

### 1. 更新费用计算逻辑
**修复前：**
```typescript
// 错误：尝试调用不存在的函数
const updateFee = await publicClient.readContract({
  address: priceAggregatorAddress,
  abi: PRICE_AGGREGATOR_ABI,
  functionName: "getUpdateFee",
  args: [pythUpdateData]
}) as bigint;
```

**修复后：**
```typescript
// 正确：使用 PythPriceFeed 计算费用
const pythPriceFeedAddress = priceAggregatorAddress; // 在某些架构中，PriceAggregator 就是 PythPriceFeed
const updateFee = await publicClient.readContract({
  address: pythPriceFeedAddress,
  abi: PRICE_AGGREGATOR_ABI,
  functionName: "getUpdateFee",
  args: [pythUpdateData]
}) as bigint;
```

### 2. 更新日志信息
```typescript
// 修复前
console.log("💰 PriceAggregator 更新费用:");

// 修复后
console.log("💰 PythPriceFeed 更新费用:");
```

### 3. 保持价格获取逻辑不变
```typescript
// 价格获取逻辑保持不变
const currentPrice = await publicClient.readContract({
  address: priceAggregatorAddress,
  abi: PRICE_AGGREGATOR_ABI,
  functionName: "getAggregatedPrice",
  args: [token.symbol, updateDataArray],
  value: updateFee
}) as bigint;
```

## 架构说明

在某些部署架构中，`PriceAggregator` 合约实际上就是 `PythPriceFeed` 合约，或者是包含 PythPriceFeed 功能的聚合器。因此：

1. **费用计算**：使用 `getUpdateFee(pythUpdateData)`
2. **价格获取**：使用 `getAggregatedPrice(symbol, updateDataArray, { value: updateFee })`
3. **费用支付**：在调用合约时，将 `updateFee` 作为 `value` 参数传递

## 修复验证

修复后的逻辑与测试用例完全一致：
- ✅ 使用 PythPriceFeed 计算费用
- ✅ 费用传递给合约的 `value` 参数
- ✅ 保持价格获取逻辑不变
- ✅ 与测试用例中的调用方式一致

## 测试建议

建议进行以下测试：
1. 使用测试用例验证修复结果
2. 检查费用计算是否正确
3. 确认交易能否正常执行

## 相关文件
- `/lib/hooks/useTokenTrading.ts` - 主要修复文件
- `/CryptoStockContract/test/12-PriceOracle-AAPL.test.js` - 参考测试用例
- `/lib/abi/PriceAggregator.json` - PriceAggregator ABI 文件
- `/lib/abi/deployments-uups-sepolia.json` - 部署配置文件